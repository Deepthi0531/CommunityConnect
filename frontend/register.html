<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register - CommunityConnect</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      background: #f8f9fa;
    }
    .register-container {
      max-width: 950px;
      margin: 60px auto;
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 32px;
      flex-wrap: wrap;
    }
    .card {
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(44,62,80,.1);
      border: none;
      flex: 1 1 350px;
      max-width: 400px;
    }
    .location-panel {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 16px rgba(44,62,80,.08);
      padding: 24px;
      width: 350px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #map {
      height: 210px;
      width: 100%;
      border-radius: 12px;
    }
    .location-coords {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      gap: 10px;
    }
    .location-coords > div {
      flex: 1;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
      color: #333;
      display: none;
      z-index: 9999;
    }
    @media (max-width: 900px) {
      .register-container {
        flex-direction: column;
        align-items: center;
      }
      .location-panel, .card {
        width: 100%;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading">Registering...</div>

  <div class="register-container">
    <!-- Registration Form Card -->
    <div class="card p-4">
      <h3 class="text-center mb-3">Register</h3>
      <form id="register-form" novalidate>
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input type="text" id="name" class="form-control" required />
          <div class="invalid-feedback">Please enter your name.</div>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" class="form-control" required />
          <div class="invalid-feedback">Please enter a valid email.</div>
        </div>

        <div class="mb-3">
          <label for="role" class="form-label">Role</label>
          <select id="role" class="form-select" required>
            <option value="user" selected>User</option>
            <option value="volunteer">Volunteer</option>
          </select>
          <div class="invalid-feedback">Please select a role.</div>
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <input type="password" id="password" class="form-control" minlength="6" required />
          <div class="invalid-feedback">Password must be at least 6 characters.</div>
        </div>

        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number</label>
          <input type="tel" id="phone" class="form-control" placeholder="+1234567890" required />
          <div class="invalid-feedback">Please enter your phone number.</div>
        </div>

        <!-- Hidden input fields for lat/lon sent to backend -->
        <input type="hidden" id="latitude" name="latitude" required />
        <input type="hidden" id="longitude" name="longitude" required />

        <p id="error-message" class="text-danger text-center mt-2"></p>

        <button type="submit" class="btn btn-success w-100">Register</button>
      </form>

      <p class="text-center mt-3">
        Already have an account? <a href="login.html">Login</a>
      </p>
    </div>

    <!-- Location Selection Panel -->
    <div class="location-panel">
      <label for="map" class="mb-1 fw-semibold">Select Your Location</label>
      <div id="map" aria-label="Location map" role="region" tabindex="0"></div>

      <div class="location-coords">
        <div>
          <label for="display-latitude" class="form-label small">Latitude</label>
          <input type="text" id="display-latitude" class="form-control form-control-sm" readonly />
        </div>
        <div>
          <label for="display-longitude" class="form-label small">Longitude</label>
          <input type="text" id="display-longitude" class="form-control form-control-sm" readonly />
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    (() => {
      const map = L.map('map').setView([22.5726, 88.3639], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      let marker;

      map.on('click', function (e) {
        if (marker) map.removeLayer(marker);

        marker = L.marker(e.latlng).addTo(map);

        // Set hidden input values to submit with form
        document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
        document.getElementById('longitude').value = e.latlng.lng.toFixed(6);

        // Set readonly display inputs
        document.getElementById('display-latitude').value = e.latlng.lat.toFixed(6);
        document.getElementById('display-longitude').value = e.latlng.lng.toFixed(6);

        // Clear error if any on location selection
        document.getElementById('error-message').textContent = '';
      });

      const form = document.getElementById('register-form');
      const loadingOverlay = document.getElementById('loading');
      const errorMessage = document.getElementById('error-message');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Clear previous errors
        errorMessage.textContent = '';

        // Validate form fields with HTML5 constraint validation
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        // Validate location fields explicitly
        const latVal = document.getElementById('latitude').value.trim();
        const lonVal = document.getElementById('longitude').value.trim();

        if (!latVal || !lonVal || isNaN(parseFloat(latVal)) || isNaN(parseFloat(lonVal))) {
          errorMessage.textContent = 'Please select a valid location on the map.';
          return;
        }

        // Prepare payload including phone
        const payload = {
          name: document.getElementById('name').value.trim(),
          email: document.getElementById('email').value.trim(),
          role: document.getElementById('role').value,
          password: document.getElementById('password').value,
          phone: document.getElementById('phone').value.trim(),
          latitude: parseFloat(latVal),
          longitude: parseFloat(lonVal),
        };

        try {
          loadingOverlay.style.display = 'flex';

          const response = await fetch('http://localhost:5000/api/users/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await response.json();

          loadingOverlay.style.display = 'none';

          if (response.ok) {
            alert('Registration successful!');
            window.location.href = 'login.html';
          } else {
            errorMessage.textContent = data.message || 'Registration failed.';
          }
        } catch (error) {
          loadingOverlay.style.display = 'none';
          errorMessage.textContent = 'Server error, please try again later.';
          console.error('Registration error:', error);
        }
      });
    })();
  </script>
</body>
</html>
