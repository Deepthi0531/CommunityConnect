<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>CommunityConnect - Local Help Portal</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  
  <!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"

/>
<style>
    .profile-picture-navbar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
    }
</style>
  
  <style>
    /* Set height for map container */
    #map {
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
 <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="index.html">
             <img src="favicon.ico" alt="Logo" style="width: 30px; height: 30px; margin-right: 10px;">
            CommunityConnect
        </a>

        <div class="ms-auto" id="nav-container">

            <div id="guest-nav" class="d-flex align-items-center">
                <a class="btn btn-danger me-2" href="emergency.html">Emergency</a>
                <a href="login.html" class="btn btn-outline-light">Login</a>
            </div>

            <div id="user-nav" class="d-none d-flex align-items-center">
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="btn btn-danger me-2" href="emergency.html">Emergency</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">Home</a>
                    </li>
                </ul>

                <div class="dropdown ms-3">
                    <a href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <img src="https://t4.ftcdn.net/jpg/00/64/67/63/360_F_64676383_LdbmhiNM6Ypzb3FM4PPuFP9rHe7ri8Ju.jpg" 
                      id="navbarProfileImage" class="profile-picture-navbar"
                      alt="User Profile">
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html">Profile</a></li>
                        <li><a class="dropdown-item" href="settings.html">Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logout-button">Logout</a></li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</nav>

  <!-- Hero Section -->
  <header class="hero-section text-center text-white d-flex flex-column justify-content-center align-items-center">
    <h1 class="display-4 fw-bold">CommunityConnect</h1>
    <p class="lead">Find Help or Offer Help in Your Local Area</p>
    <div class="mt-3">
      <a href="createhelp.html" class="btn btn-light btn-lg me-2">Create Request</a>
      <a href="volunteer.html" class="btn btn-outline-light btn-lg">Join as Volunteer</a>
    </div>
  </header>

  <!-- Categories -->
  <section class="container my-5">
    <h2 class="text-center mb-4">Categories</h2>
    <div class="row text-center">
      <div class="col-md-3 category-card">
        <img src="assets/icons/blood.jpg" width="110">
        <p>Blood</p>
      </div>
      <div class="col-md-3 category-card">
        <img src="assets/icons/food.jpg" width="90">
        <p>Food</p>
      </div>
      <div class="col-md-3 category-card">
        <img src="assets/icons/rescue.jpg" width="120">
        <p>Rescue</p>
      </div>
      <div class="col-md-3 category-card">
        <img src="assets/icons/lost.jpg" width="160">
        <p>Lost & Found</p>
      </div>
    </div>
  </section>

  <!-- Map & Requests -->
  <div class="container my-5">
    <h2 class="text-center">Nearby Requests</h2>
    <div id="map" class="rounded shadow"></div>
    <ul id="requests" class="list-group mt-3 shadow-sm"></ul>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center p-3 mt-5">
    &copy; 2025 CommunityConnect | Local Help Portal
  </footer>

  <!-- Leaflet JS -->
  <script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  
></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <!-- Initialize Leaflet Map -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const guestNav = document.getElementById('guest-nav');
        const userNav = document.getElementById('user-nav');
        const logoutButton = document.getElementById('logout-button');

        if (token) {
            // If token exists, show the user navbar
            guestNav.classList.add('d-none'); // Hide guest view
            userNav.classList.remove('d-none'); // Show user view

            try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const navbarImage = document.getElementById('navbarProfileImage');
            if (navbarImage) {
                navbarImage.src = payload.profile_image_url || 'https://t4.ftcdn.net/jpg/00/64/67/63/360_F_64676383_LdbmhiNM6Ypzb3FM4PPuFP9rHe7ri8Ju.jpg';
            }
        } catch (e) {
            console.error("Failed to decode token for navbar image:", e);
        }
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.reload(); // Reload the page to show the guest view
            });
        }
    });
    // Function to initialize map
    function initMap() {
      // Set view to some default location and zoom (e.g. center of India)
      var map = L.map('map').setView([20.5937, 78.9629], 5);

      // Add OpenStreetMap tiles layer with attribution
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // Example marker in the center; you can dynamically add markers later
      L.marker([20.5937, 78.9629]).addTo(map)
      .bindPopup('CommunityConnect').openPopup();
    }

    // Initialize map after DOM content is loaded
    document.addEventListener('DOMContentLoaded', initMap);

    // for message socket.io
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) return;

    // Connect to the Socket.IO server
    const socket = io("http://localhost:5000"); // Your backend URL

    // Decode token to get user ID
    const payload = JSON.parse(atob(token.split('.')[1]));
    const userId = payload.id;

    // Tell the server to put this socket in a room named after the user ID
    socket.emit('join-room', userId);

    // --- This is where the magic happens ---
    // Listen for new help requests (if you are a volunteer)
    socket.on('new-help-request', (requestData) => {
        // Show a pop-up to the volunteer
        if (confirm(`${requestData.name} from ${requestData.location} needs help. Do you want to accept?`)) {
            socket.emit('request-accepted', { requestId: requestData.id, volunteerId: userId });
        } else {
            // Do nothing or emit a 'request-rejected' event
        }
    });

    // Listen for updates on your own request
    socket.on('request-timeout', (data) => {
        alert("Sorry, no volunteer is accepting your request at this time.");
    });

    socket.on('your-request-accepted', (data) => {
        alert(`A volunteer has accepted your request!`);
    });
});
  </script>

  <script src="js/script.js"></script>
</body>
</html>
