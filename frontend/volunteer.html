<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register as Volunteer | CommunityConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <!-- Custom CSS -->
  <style>
    :root{
      --cc-bg: #0f172a;
      --cc-accent: #0d6efd;
      --cc-soft: #f8fafc;
      --cc-muted: #6c757d;
    }
    body { background: #ffffff; }
    .navbar { box-shadow: 0 2px 10px rgba(0,0,0,.08); }
    .hero-section{
      background: linear-gradient(135deg, #173426 0%, #1f9c77 100%);
      color:#fff; padding: 48px 0; text-align:center;
    }
    .hero-section h1{ font-weight: 700; }
    .page-card{
      background: #fff;
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .section-title{ font-weight: 700; }
    .form-label{ font-weight: 600; }
    .hint{ font-size: .9rem; color: var(--cc-muted); }
    .map-wrap{
      border: 1px solid rgba(0,0,0,.08);
      border-radius: .75rem; overflow: hidden;
      background: var(--cc-soft);
    }
    #map{ width:100%; height: 300px; }
    footer{ margin-top: 48px; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="index.html">CommunityConnect</a>
    <div class="ms-auto">
      <a href="index.html" class="btn btn-outline-light">Home</a>
      <a href="login.html" class="btn btn-outline-light ms-2">Login</a>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero-section">
    <div class="container">
      <h1>Volunteer Registration</h1>
      <p class="mb-0">Join the community effort. Register as a volunteer today!</p>
    </div>
  </header>

  <!-- Content -->
  <main class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="page-card p-4 p-md-5">
          <div class="text-center mt-4 border-top pt-3">
            <p class="mb-0">Already have an account?</p>
            <a href="volunteer-login.html" class="btn btn-outline-primary mt-2">Login Here</a>
        </div>
          <h2 class="section-title mb-4">Your Details</h2>

          <div id="formAlert" class="alert d-none" role="alert"></div>

          <form id="volunteerForm" novalidate>
            <div class="row g-4">

              <div class="col-md-6">
                <label class="form-label required" for="name">Full Name</label>
                <input class="form-control" id="name" name="name" type="text" required placeholder="Your Name">
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="email">Email</label>
                <input class="form-control" id="email" name="email" type="email" required placeholder="you@example.com">
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="phone">Phone</label>
                <input class="form-control" id="phone" name="phone" type="text" required placeholder="Your Phone Number">
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="availability">Availability</label>
                <select class="form-select" id="availability" name="availability" required>
                  <option value="">Select</option>
                  <option value="yes">Available</option>
                  <option value="no">Not Available</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label required" for="password">Password</label>
                <input class="form-control" id="password" name="password" type="password" required>
              </div>
              <!-- <div class="col-md-6">
                <label class="form-label required" for="confirm_password">Confirm Password</label>
                <input class="form-control" id="confirm_password" name="confirm_password" type="password" required>
              </div> -->

              <div class="col-12">
                <label class="form-label required" for="skills">Skills</label>
                <textarea class="form-control" id="skills" name="skills" rows="4" required
                  placeholder="E.g., First Aid, Cooking, Transport, Nursing..."></textarea>
              </div>

              <div class="col-12">
                <label class="form-label">Location (Optional)</label>
                <div class="map-wrap">
                  <div id="map"></div>
                </div>
                <small class="hint">Click on the map to drop a marker. This helps us match you with nearby requests.</small>
                <input type="hidden" id="latitude" name="latitude" />
                <input type="hidden" id="longitude" name="longitude" />
              </div>

              <div class="col-12 d-flex gap-3 mt-3">
                <button type="submit" class="btn btn-success">Register</button>
                <button type="reset" class="btn btn-outline-secondary">Reset</button>
              </div>

            </div>
          </form>

        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center p-3">
    &copy; 2025 CommunityConnect | Local Help Portal
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    let map, marker;
    const defaultCoords = [12.2958, 76.6394]; // Mysuru default

    document.addEventListener("DOMContentLoaded", () => {
        
        map = L.map('map').setView(defaultCoords, 13); // Set default view first

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Add draggable marker at the default location
        marker = L.marker(defaultCoords, { draggable: true }).addTo(map);
        setLatLng(defaultCoords[0], defaultCoords[1]);

        // --- ATTEMPT TO GET LIVE LOCATION ---
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const liveCoords = [position.coords.latitude, position.coords.longitude];
                    map.setView(liveCoords, 13);
                    marker.setLatLng(liveCoords);
                    setLatLng(liveCoords[0], liveCoords[1]);
                },
                (error) => {
                    console.warn("Could not get geolocation:", error.message);
                }
            );
        } else {
            console.log("Geolocation is not supported by this browser.");
        }

        // Place marker on click
        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            setLatLng(e.latlng.lat, e.latlng.lng);
        });

        // Update coordinates on marker drag
        marker.on('dragend', function(e) {
            const pos = marker.getLatLng();
            setLatLng(pos.lat, pos.lng);
        });

        function setLatLng(lat, lng) {
            document.getElementById("latitude").value = lat.toFixed(6);
            document.getElementById("longitude").value = lng.toFixed(6);
        }

        // Form logic
        const form = document.getElementById("volunteerForm");
        const alertBox = document.getElementById("formAlert");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!form.checkValidity()) {
                showAlert("Please fill all required fields.", "danger");
                form.classList.add("was-validated");
                return;
            }

            // --- FIX 1: Get password values correctly ---
            const password = form.password.value;
            // const confirmPassword = form.confirm_password.value;

            // if (password !== confirmPassword) {
            //     showAlert("Passwords do not match.", "danger");
            //     return;
            // }

            const payload = {
                name: form.name.value.trim(),
                email: form.email.value.trim(),
                phone: form.phone.value.trim(),
                password: password, // <-- Use the variable defined above
                availability: form.availability.value,
                skills: form.skills.value.trim(),
                latitude: form.latitude.value,
                longitude: form.longitude.value,
            };

            try {
                const response = await fetch('http://localhost:5000/api/volunteers/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // --- FIX 2: Removed Authorization header ---
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert("You have been registered as a volunteer! Please log in.", "success");
                    form.reset();
                    map.setView(defaultCoords, 13);
                    marker.setLatLng(defaultCoords);
                    setLatLng(defaultCoords[0], defaultCoords[1]);
                } else {
                    showAlert(data.message || "Registration failed.", "danger");
                }
            } catch (error) {
                showAlert("An error occurred. Please try again.", "danger");
                console.error("Registration error:", error);
            }
        });

        function showAlert(message, type) {
            if (!message) {
                alertBox.className = "alert d-none";
                alertBox.textContent = "";
                return;
            }
            alertBox.className = "alert alert-" + type;
            alertBox.textContent = message;
        }
    });

    // --- FIX 3: Removed the entire second 'DOMContentLoaded' listener ---
    // (That Socket.IO code should be moved to dashboard.html or profile.html)
</script>
</body>
</html>
